name: CI/CD to Elastic Beanstalk

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  EB_APP_NAME: india-forecaster
  EB_ENV_NAME: india-forecaster-env

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install AWS & EB CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip zip
          pip3 install awsebcli

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create EB config
        run: |
          mkdir -p .elasticbeanstalk
          echo "options:" > .elasticbeanstalk/config.yml
          echo "  platform: arn:aws:elasticbeanstalk:${AWS_REGION}::platform/Docker running on 64bit Amazon Linux 2/4.3.3" >> .elasticbeanstalk/config.yml
          echo "  application_name: ${EB_APP_NAME}" >> .elasticbeanstalk/config.yml
          echo "  environment_name: ${EB_ENV_NAME}" >> .elasticbeanstalk/config.yml
          echo "global:" >> .elasticbeanstalk/config.yml
          echo "  region: ${AWS_REGION}" >> .elasticbeanstalk/config.yml

      - name: Initialize EB CLI
        run: |
          eb init $EB_APP_NAME \
            --platform "Docker running on 64bit Amazon Linux 2" \
            --region $AWS_REGION \
            --quiet

      - name: Set EB environment
        run: eb use $EB_ENV_NAME --quiet

      - name: Zip app for EB
        run: zip -r app.zip . -x "*.git*" "node_modules/*" ".github/*" "*.md"

      - name: Deploy to Elastic Beanstalk
        run: eb deploy --staged --timeout 30
